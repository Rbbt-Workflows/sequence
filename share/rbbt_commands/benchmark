#!/usr/bin/env ruby

require 'rbbt-util'
require 'rbbt/workflow'
require 'rbbt/util/R'

Workflow.require_workflow "Sequence"
Workflow.require_workflow "Annovar"

options = SOPT.get('-m--method*:-p--plot*')

file, *sizes = ARGV

plot = options[:plot] || 'plot.png'
options[:method] = options[:method].split(",") if options[:method]
log = Log.severity
times = {
  "ANNOVAR" => [],
  "Sequence_nostream" => [], 
  "Sequence" => [], 
  "Sequence_exec" => [], 
  "Sequence_fast" => [], 
  "Sequence_fast_no_MP" => [], 
}

sizes.each do |size|
  size = size.to_i

  text = ""
  text = Open.read(file).split("\n").reject{|l| l =~ /^M:/}[1..size] * "\n"

  TmpFile.with_file(text) do |tmpfile|
    Path.setup(tmpfile)

    jobname = [File.basename(file), size] * "."
    if options[:method].nil? or options[:method].include? "ANNOVAR"
      Log.info "annovar" + " " +  size.to_s
      job = Annovar.job(:analysis, jobname, :genomic_mutations => Open.read(tmpfile).split("\n"))
      job.fork.join
      time = job.info[:process_time]
      times["ANNOVAR"] << time
      Log.info Log.color(:red, "annovar") + " " + Log.color(:blue, size.to_s) + " " + Log.color(:yellow, time.to_i)
    end

    if options[:method].nil? or options[:method].include? "Sequence_nostream"
      Log.info "Sequence_nostream" + " " +  size.to_s
      ENV["RBBT_NO_STREAM"] = "true"
      job = Sequence.job(:mutated_isoforms, jobname + ".no_stream", :mutations => tmpfile).recursive_clean
      start = Time.now
      job.fork.join
      ENV["RBBT_NO_STREAM"] = nil
      time = Time.now - start
      times["Sequence_nostream"] << time
      Log.info Log.color(:red, "Sequence_nostream") + " " + Log.color(:blue, size.to_s) + " " + Log.color(:yellow, time.to_i)
    end

    if options[:method].nil? or options[:method].include? "Sequence"
      Open.open(tmpfile) do |f|
        Log.info "Sequence" + " " +  size.to_s
        job = Sequence.job(:mutated_isoforms, jobname + ".steps", :mutations => f).recursive_clean
        job.fork.join
        time = job.info[:time_elapsed]
        times["Sequence"] << time
        Log.info Log.color(:red, "Sequence") + " " + Log.color(:blue, size.to_s) + " " + Log.color(:yellow, time.to_i)
      end
    end

    if options[:method].nil? or options[:method].include? "Sequence_exec"
      Open.open(tmpfile) do |f|
        Log.info "Sequence_exec" + " " +  size.to_s
        job = Sequence.job(:mutated_isoforms, jobname + ".exec", :mutations => f).recursive_clean
        start = Time.now
        res = job.exec(true)
        res.read
        time = Time.now - start
        times["Sequence_exec"] << time
        Log.info Log.color(:red, "Sequence_exec") + " " + Log.color(:blue, size.to_s) + " " + Log.color(:yellow, time.to_i)
      end
    end

    if options[:method].nil? or options[:method].include? "Sequence_fast_no_MP"
      Open.open(tmpfile) do |f|
        Log.info "Sequence_fast_no_MP" + " " +  size.to_s
        ENV["RBBT_NO_MAP_REDUCE"] = "true"
        job = Sequence.job(:mutated_isoforms_fast, jobname + ".no_mp", :mutations => f).recursive_clean
        job.fork.join
        ENV["RBBT_NO_MAP_REDUCE"] = nil
        time = job.info[:time_elapsed]
        times["Sequence_fast_no_MP"] << time
        Log.info Log.color(:red, "Sequence_fast_no_MP") + " " + Log.color(:blue, size.to_s) + " " + Log.color(:yellow, time.to_i)
      end
    end

    if options[:method].nil? or options[:method].include? "Sequence_fast"
      Open.open(tmpfile) do |f|
        Log.info "Sequence_fast" + " " +  size.to_s
        job = Sequence.job(:mutated_isoforms_fast, jobname + ".fast", :mutations => f).recursive_clean
        job.fork.join
        time = job.info[:time_elapsed]
        times["Sequence_fast"] << time
        Log.info Log.color(:red, "Sequence_fast") + " " + Log.color(:blue, size.to_s) + " " + Log.color(:yellow, time.to_i)
      end
    end
  end
end

TSV.setup(times, :key_field => "Method", :fields => sizes, :type => :list, :cast => :to_i)

puts Log.color :magenta, "Benchmark results"

puts times.to_s

times.R <<-EOF

library('reshape')
library('ggplot2')

data$Method = rownames(data)
m = melt(data)
m$variable = as.numeric(as.character(m$variable))
names(m) <- c("Method", "Size", "Time")
plot = qplot(Size, Time, colour=Method, group=Method, data = m) + geom_line() 
ggsave(plot, file='#{plot}')
EOF

raise "No file" unless File.exists? plot
puts Log.color :magenta, "Plot saved at:"
puts plot
